# 介绍
SQL引擎主要的工作是将SQL语句进行解析、优化和执行，在这个流程中，核心的数据结构包括解析树、查询树、计划树、执行状态树等，本文介绍如何将解析树、查询树和计划树进行可视化分析。

# 工具
https://github.com/Teletele-Lin/PGNode2Graph

# 使用
## GDB模式下
GDB模式下执行nodeToString函数，将解析树、查询树、计划树进行序列化，对于以下SQL进行可视化：
```sql
-- 表定义
CREATE TABLE customers (
    id INT PRIMARY KEY,
    name VARCHAR(100),
    country VARCHAR(50),
    city VARCHAR(50),
    registration_date DATE
);
```
```sql
-- 查询
select * from customers where id = 10;
```
GDB命令：
```
set print elements 0
p nodeToString(parsetree_list)
p nodeToString(querytree_list)
p nodeToString(plantree_list)
```
得到序列化之后的结果
解析树：
```
$3 = 0x5dd220d06920 "({RAWSTMT :stmt {SELECTSTMT :distinctClause <> :intoClause <> :targetList ({RESTARGET :name <> :indirection <> :val {COLUMNREF :fields ({A_STAR}) :location -1} :location -1}) :fromClause ({RANGEVAR :catalogname <> :schemaname <> :relname customers :inh true :relpersistence p :alias <> :location -1}) :whereClause {A_EXPR :name (\"=\") :lexpr {COLUMNREF :fields (\"id\") :location -1} :rexpr {A_CONST :val 10 :location -1} :rexpr_list_start -1 :rexpr_list_end -1 :location -1} :groupClause <> :groupDistinct false :havingClause <> :windowClause <> :valuesLists <> :sortClause <> :limitOffset <> :limitCount <> :limitOption 0 :lockingClause <> :withClause <> :op 0 :all false :larg <> :rarg <>} :stmt_location -1 :stmt_len -1})"
```
查询树：
```
$4 = 0x5dd220ddcda0 "({QUERY :commandType 1 :querySource 0 :canSetTag true :utilityStmt <> :resultRelation 0 :hasAggs false :hasWindowFuncs false :hasTargetSRFs false :hasSubLinks false :hasDistinctOn false :hasRecursive false :hasModifyingCTE false :hasForUpdate false :hasRowSecurity false :hasGroupRTE false :isReturn false :cteList <> :rtable ({RANGETBLENTRY :alias <> :eref {ALIAS :aliasname customers :colnames (\"id\" \"name\" \"country\" \"city\" \"registration_date\")} :rtekind 0 :relid 16389 :inh true :relkind r :rellockmode 1 :perminfoindex 1 :tablesample <> :lateral false :inFromCl true :securityQuals <>}) :rteperminfos ({RTEPERMISSIONINFO :relid 16389 :inh true :requiredPerms 2 :checkAsUser 0 :selectedCols (b 8 9 10 11 12) :insertedCols (b) :updatedCols (b)}) :jointree {FROMEXPR :fromlist ({RANGETBLREF :rtindex 1}) :quals {OPEXPR :opno 96 :opfuncid 65 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({VAR :varno 1 :varattno 1 :vartype 23 :vartypmod -1 :varcollid 0 :varnullingrels (b) :varlevelsup 0 :varreturningtype 0 :varnosyn 1 :varattnosyn 1 :location -1} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 10 0 0 0 0 0 0 0 ]}) :location -1}} :mergeActionList <> :mergeTargetRelation 0 :mergeJoinCondition <> :targetList ({TARGETENTRY :expr {VAR :varno 1 :varattno 1 :vartype 23 :vartypmod -1 :varcollid 0 :varnullingrels (b) :varlevelsup 0 :varreturningtype 0 :varnosyn 1 :varattnosyn 1 :location -1} :resno 1 :resname id :ressortgroupref 0 :resorigtbl 16389 :resorigcol 1 :resjunk false} {TARGETENTRY :expr {VAR :varno 1 :varattno 2 :vartype 1043 :vartypmod 104 :varcollid 100 :varnullingrels (b) :varlevelsup 0 :varreturningtype 0 :varnosyn 1 :varattnosyn 2 :location -1} :resno 2 :resname name :ressortgroupref 0 :resorigtbl 16389 :resorigcol 2 :resjunk false} {TARGETENTRY :expr {VAR :varno 1 :varattno 3 :vartype 1043 :vartypmod 54 :varcollid 100 :varnullingrels (b) :varlevelsup 0 :varreturningtype 0 :varnosyn 1 :varattnosyn 3 :location -1} :resno 3 :resname country :ressortgroupref 0 :resorigtbl 16389 :resorigcol 3 :resjunk false} {TARGETENTRY :expr {VAR :varno 1 :varattno 4 :vartype 1043 :vartypmod 54 :varcollid 100 :varnullingrels (b) :varlevelsup 0 :varreturningtype 0 :varnosyn 1 :varattnosyn 4 :location -1} :resno 4 :resname city :ressortgroupref 0 :resorigtbl 16389 :resorigcol 4 :resjunk false} {TARGETENTRY :expr {VAR :varno 1 :varattno 5 :vartype 1082 :vartypmod -1 :varcollid 0 :varnullingrels (b) :varlevelsup 0 :varreturningtype 0 :varnosyn 1 :varattnosyn 5 :location -1} :resno 5 :resname registration_date :ressortgroupref 0 :resorigtbl 16389 :resorigcol 5 :resjunk false}) :override 0 :onConflict <> :returningOldAlias <> :returningNewAlias <> :returningList <> :groupClause <> :groupDistinct false :groupingSets <> :havingQual <> :windowClause <> :distinctClause <> :sortClause <> :limitOffset <> :limitCount <> :limitOption 0 :rowMarks <> :setOperations <> :constraintDeps <> :withCheckOptions <> :stmt_location -1 :stmt_len -1})"
```
计划树：
```
$5 = 0x5dd220e38e60 "({PLANNEDSTMT :commandType 1 :queryId 0 :planId 0 :hasReturning false :hasModifyingCTE false :canSetTag true :transientPlan false :dependsOnRole false :parallelModeNeeded false :jitFlags 0 :planTree {INDEXSCAN :scan.plan.disabled_nodes 0 :scan.plan.startup_cost 0.145 :scan.plan.total_cost 8.1625 :scan.plan.plan_rows 1 :scan.plan.plan_width 462 :scan.plan.parallel_aware false :scan.plan.parallel_safe true :scan.plan.async_capable false :scan.plan.plan_node_id 0 :scan.plan.targetlist ({TARGETENTRY :expr {VAR :varno 1 :varattno 1 :vartype 23 :vartypmod -1 :varcollid 0 :varnullingrels (b) :varlevelsup 0 :varreturningtype 0 :varnosyn 1 :varattnosyn 1 :location -1} :resno 1 :resname id :ressortgroupref 0 :resorigtbl 16389 :resorigcol 1 :resjunk false} {TARGETENTRY :expr {VAR :varno 1 :varattno 2 :vartype 1043 :vartypmod 104 :varcollid 100 :varnullingrels (b) :varlevelsup 0 :varreturningtype 0 :varnosyn 1 :varattnosyn 2 :location -1} :resno 2 :resname name :ressortgroupref 0 :resorigtbl 16389 :resorigcol 2 :resjunk false} {TARGETENTRY :expr {VAR :varno 1 :varattno 3 :vartype 1043 :vartypmod 54 :varcollid 100 :varnullingrels (b) :varlevelsup 0 :varreturningtype 0 :varnosyn 1 :varattnosyn 3 :location -1} :resno 3 :resname country :ressortgroupref 0 :resorigtbl 16389 :resorigcol 3 :resjunk false} {TARGETENTRY :expr {VAR :varno 1 :varattno 4 :vartype 1043 :vartypmod 54 :varcollid 100 :varnullingrels (b) :varlevelsup 0 :varreturningtype 0 :varnosyn 1 :varattnosyn 4 :location -1} :resno 4 :resname city :ressortgroupref 0 :resorigtbl 16389 :resorigcol 4 :resjunk false} {TARGETENTRY :expr {VAR :varno 1 :varattno 5 :vartype 1082 :vartypmod -1 :varcollid 0 :varnullingrels (b) :varlevelsup 0 :varreturningtype 0 :varnosyn 1 :varattnosyn 5 :location -1} :resno 5 :resname registration_date :ressortgroupref 0 :resorigtbl 16389 :resorigcol 5 :resjunk false}) :scan.plan.qual <> :scan.plan.lefttree <> :scan.plan.righttree <> :scan.plan.initPlan <> :scan.plan.extParam (b) :scan.plan.allParam (b) :scan.scanrelid 1 :indexid 16393 :indexqual ({OPEXPR :opno 96 :opfuncid 65 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({VAR :varno -3 :varattno 1 :vartype 23 :vartypmod -1 :varcollid 0 :varnullingrels (b) :varlevelsup 0 :varreturningtype 0 :varnosyn 1 :varattnosyn 1 :location -1} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 10 0 0 0 0 0 0 0 ]}) :location -1}) :indexqualorig ({OPEXPR :opno 96 :opfuncid 65 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({VAR :varno 1 :varattno 1 :vartype 23 :vartypmod -1 :varcollid 0 :varnullingrels (b) :varlevelsup 0 :varreturningtype 0 :varnosyn 1 :varattnosyn 1 :location -1} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location -1 :constvalue 4 [ 10 0 0 0 0 0 0 0 ]}) :location -1}) :indexorderby <> :indexorderbyorig <> :indexorderbyops <> :indexorderdir 1} :partPruneInfos <> :rtable ({RANGETBLENTRY :alias <> :eref {ALIAS :aliasname customers :colnames (\"id\" \"name\" \"country\" \"city\" \"registration_date\")} :rtekind 0 :relid 16389 :inh false :relkind r :rellockmode 1 :perminfoindex 1 :tablesample <> :lateral false :inFromCl true :securityQuals <>}) :unprunableRelids (b 1) :permInfos ({RTEPERMISSIONINFO :relid 16389 :inh true :requiredPerms 2 :checkAsUser 0 :selectedCols (b 8 9 10 11 12) :insertedCols (b) :updatedCols (b)}) :resultRelations <> :appendRelations <> :subplans <> :rewindPlanIDs (b) :rowMarks <> :relationOids (o 16389) :invalItems <> :paramExecTypes <> :utilityStmt <> :stmt_location -1 :stmt_len -1})"
```

## psql命令行模式
命令行模式中，开启相关参数，可在内核日志中打印序列化后的树
```sql
set debug_print_parse = on;
SET debug_print_rewritten = ON;
set debug_print_plan = on;
set debug_pretty_print = on;
```

# 可视化
- 部署PGNode2Graph项目(Python Django项目)
- 粘贴序列化后的结果，详情参考PGNode2Graph项目文档
